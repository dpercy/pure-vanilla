<style>

  /* styles */
  textarea {
    font-family: Monaco, Consolas, monospace;
    font-size: 26px;
  }
  .error {
    font-color: red;
  }

  /* layout */
  #workspace {
    width: 100%;
    height: 100%;
    display: flex;
  }
  #workspace > * {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  #workspace > * > * {
    width: 100%;
    height: 100%;
  }

</style>

<div id="workspace">
  <div>
    <textarea placeholder="definitions" id="definitions"></textarea>
    <textarea disabled hidden id="def-errors" class="error"></textarea>
  </div>
  <div>
    <textarea placeholder="expression" id="query"></textarea>
    <textarea placeholder="result" disabled id="results"></textarea>
  </div>
</div>

<script>
  var defsWindow = document.getElementById('definitions');
  var defErrorsWindow = document.getElementById('def-errors');
  var queryWindow = document.getElementById('query');
  var resultsWindow = document.getElementById('results');

  // On page load, use addDefs with an empty list of new definitions
  // to query the current set of definitions.
  // Then use that to populate the initial definitions window.
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/addDefs", true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      defsWindow.value = xhr.responseText;
    }
  };
  xhr.send('');

  function redef() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/setDefs", true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        if (xhr.status == 200) {
          // yay
          console.log('setDefs', xhr.responseText);
          // whenever you redef, also requery,
          // since the query depends on the defs
          defErrorsWindow.value = '';
	  defErrorsWindow.hidden = true;
          requery();
        } else {
          // error
          console.log('setDefs error', xhr.responseText);
          defErrorsWindow.value = xhr.responseText;
	  defErrorsWindow.hidden = false;
        }
      }
    };
    xhr.send(defsWindow.value);


    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/residualDefs", true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        if (xhr.status == 200) {
          // yay
          console.log('residualDefs', xhr.responseText);
	  eval("window.defs = " + xhr.responseText);
        } else {
          // error
          console.log('residualDefs error', xhr.responseText);
          defErrorsWindow.value = xhr.responseText;
	  defErrorsWindow.hidden = false;
        }
      }
    };
    xhr.send();
  }
  defsWindow.addEventListener('keyup', redef);

  function requery() {
    if (queryWindow.value.trim() === '') {
      resultsWindow.value = '';
    } else {
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/query", true);
      xhr.onreadystatechange = function() {
	if (xhr.readyState == 4) {
	  if (xhr.status == 200) {
    	    // yay
    	    resultsWindow.value = xhr.responseText;
	    resultsWindow.classList.remove('error');
    	    console.log('interactions result', xhr.responseText);
    	  } else {
    	    // error
    	    resultsWindow.value = xhr.responseText;
	    resultsWindow.classList.add('error');
    	    console.log('interactions error', xhr.responseText);
    	  }
	}
      };
      xhr.send(queryWindow.value);
    }
  }
  queryWindow.addEventListener('keyup', requery);

</script>
